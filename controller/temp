/*
 * Decompiled with CFR 0.151.
 * 
 * Could not load the following classes:
 *  so.fingerprint.FingerprintDirector
 *  so.fingerprint.FingerprintImage
 *  so.fingerprint.FingerprintListener
 *  so.fingerprint.FingerprintRecord
 *  so.i18n.MultiLinguisticListener
 *  so.i18n.Translator
 *  so.kernel.Global
 *  so.kernel.core.UserBiometrics
 *  so.kernel.core.UserId
 *  so.rmi.security.SSLUtilities
 *  so.swing.CapsLockHelper
 *  so.swing.CapsLockHelper$CapsLockListener
 *  so.swing.IconResourcer
 *  so.swing.KButton
 *  so.swing.KLabel
 *  so.swing.KOptionPane
 *  so.swing.KPanel
 *  so.swing.KPasswordField
 *  so.swing.KTextField
 *  so.util.DispatchThreadInvoker
 *  so.util.StringUtil
 */
package so.kernel.client.desktop;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.Frame;
import java.awt.Graphics;
import java.awt.GraphicsConfiguration;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.LayoutManager;
import java.awt.Rectangle;
import java.awt.Window;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusAdapter;
import java.awt.event.FocusEvent;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.lang.reflect.InvocationTargetException;
import java.util.Enumeration;
import java.util.Locale;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.naming.NamingException;
import javax.naming.directory.Attribute;
import javax.naming.directory.Attributes;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;
import javax.net.ssl.SSLSessionContext;
import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JPasswordField;
import javax.swing.JProgressBar;
import javax.swing.JTextField;
import javax.swing.LookAndFeel;
import javax.swing.SwingUtilities;
import javax.swing.UIDefaults;
import javax.swing.UIManager;
import javax.swing.border.AbstractBorder;
import javax.swing.border.BevelBorder;
import javax.swing.border.Border;
import javax.swing.plaf.BorderUIResource;
import javax.swing.plaf.metal.MetalLookAndFeel;
import so.fingerprint.FingerprintDirector;
import so.fingerprint.FingerprintImage;
import so.fingerprint.FingerprintListener;
import so.fingerprint.FingerprintRecord;
import so.i18n.MultiLinguisticListener;
import so.i18n.Translator;
import so.kernel.Global;
import so.kernel.client.LoginDialog;
import so.kernel.client.desktop.LoginDialogSkin;
import so.kernel.client.skinParsers.FontRewriteSkinParser;
import so.kernel.client.skinParsers.KPanelSkinParser;
import so.kernel.client.skinParsers.LoginDialogSkinParser;
import so.kernel.client.ssl.SSLInfoDialog;
import so.kernel.core.UserBiometrics;
import so.kernel.core.UserId;
import so.rmi.security.SSLUtilities;
import so.swing.CapsLockHelper;
import so.swing.IconResourcer;
import so.swing.KButton;
import so.swing.KLabel;
import so.swing.KOptionPane;
import so.swing.KPanel;
import so.swing.KPasswordField;
import so.swing.KTextField;
import so.util.DispatchThreadInvoker;
import so.util.StringUtil;

public class DefaultLoginDialogSkin
implements LoginDialogSkin {
    static JFrame iconFrame = new JFrame();
    static ImageIcon icon = IconResourcer.getIcon((String)"img/Logo.gif");
    private LoginDialog loginDialog;
    private JFrame loginFrame;
    private ImageIcon loginIcon;
    private String applicationName = null;
    private LookAndFeel lastLNF = null;
    private String sCapsOn;
    private final CapsLockHelper capsLockHelper;
    private FingerprintDirector fingerprintDirector;
    private FingerprintRecord fingerprintRecord;
    private UserId userId;
    private JLabel lIconPanel;
    private JLabel jlUserName;
    private JLabel statusLabel;
    private JLabel capslockLabel;
    private JTextField jUserName;
    private JLabel jlPasswd;
    private JPasswordField jPasswd;
    private JLabel fingerprintLabel;
    private JButton jButtonOk;
    private JButton jButtonCancel;
    private JProgressBar progressBar;
    private Dimension mySize = null;
    private JPanel iconPanel;
    private JPanel buttons;
    private final JLabel labelSecurity;
    private boolean isSetIcon = false;
    private final Object LOCK = new Object();

    public DefaultLoginDialogSkin() {
        this.labelSecurity = this.createLabelSecurity();
        this.sCapsOn = DefaultLoginDialogSkin.lng("Note: Caps Lock is down.");
        Translator.getTranslator().addMultiLinguisticListener(new MultiLinguisticListener(){

            public void languageChanged(Locale newLocale) {
                DefaultLoginDialogSkin.this.sCapsOn = DefaultLoginDialogSkin.lng("Note: Caps Lock is down.");
            }
        });
        this.capsLockHelper = new CapsLockHelper(new CapsLockHelper.CapsLockListener(){

            public void change(CapsLockHelper helper, boolean capsLockOn) {
                if (capsLockOn) {
                    DefaultLoginDialogSkin.this.setCapslockLabel(DefaultLoginDialogSkin.this.sCapsOn);
                } else {
                    DefaultLoginDialogSkin.this.setCapslockLabel("");
                }
            }
        });
    }

    protected JLabel createLabelSecurity() {
        return new JLabel(" ", 2);
    }

    protected JLabel getLIconPanel() {
        return this.lIconPanel;
    }

    protected JLabel getJlUserName() {
        return this.jlUserName;
    }

    protected JLabel getStatusLabel() {
        return this.statusLabel;
    }

    protected JLabel getCapslockLabel() {
        return this.capslockLabel;
    }

    protected JTextField getJUserName() {
        return this.jUserName;
    }

    protected JLabel getJlPasswd() {
        return this.jlPasswd;
    }

    protected JPasswordField getJPasswd() {
        return this.jPasswd;
    }

    protected JButton getJButtonOk() {
        return this.jButtonOk;
    }

    protected JButton getJButtonCancel() {
        return this.jButtonCancel;
    }

    protected JProgressBar getProgressBar() {
        return this.progressBar;
    }

    private void createLoginFrame() {
        this.createFrame();
        this.createFrameContent();
        this.createJFrameListeners();
    }

    private void setCapslockLabel(String label) {
        if (!SwingUtilities.isEventDispatchThread()) {
            throw new IllegalStateException("Not a EventDispatchThread");
        }
        this.capslockLabel.setText(label);
    }

    /*
     * WARNING - Removed try catching itself - possible behaviour change.
     */
    private void setOtherLabel(String label) {
        JLabel jLabel = this.labelSecurity;
        synchronized (jLabel) {
            this.labelSecurity.setText(label);
            Cursor cursor = Cursor.getDefaultCursor();
            this.labelSecurity.setCursor(cursor);
        }
    }

    /*
     * WARNING - Removed try catching itself - possible behaviour change.
     */
    private void setSecurityLabel(String label) {
        JLabel jLabel = this.labelSecurity;
        synchronized (jLabel) {
            this.labelSecurity.setText(label);
            Cursor cursor = Cursor.getPredefinedCursor(12);
            this.labelSecurity.setCursor(cursor);
        }
    }

    private void checkCapsLock(KeyEvent e) {
        this.capsLockHelper.check(e);
    }

    private void changeDecorationPVT(int yPosChange) {
        JFrame old = this.loginFrame;
        if (!old.isUndecorated() && !UIManager.getLookAndFeel().getSupportsWindowDecorations()) {
            return;
        }
        if (this.lastLNF != null && UIManager.getLookAndFeel().getName().equals(this.lastLNF.getName())) {
            if (old.getRootPane().getWindowDecorationStyle() == 2) {
                return;
            }
            if (UIManager.getLookAndFeel().getSupportsWindowDecorations()) {
                this.mySize = null;
                old.getRootPane().setWindowDecorationStyle(2);
                this.mySize = old.getSize();
            }
        }
        this.loginFrame = null;
        JFrame frame = this.createFrame();
        frame.setLocation(old.getLocation().x, old.getLocation().y + yPosChange);
        JComponent comp = (JComponent)old.getContentPane();
        old.setContentPane(new JPanel());
        frame.setContentPane(comp);
        frame.pack();
        frame.setVisible(true);
        old.setVisible(false);
        this.mySize = frame.getSize();
        this.createJFrameListeners();
        old.setVisible(false);
    }

    private void checkAutoUser() {
        if (!this.isLazyStartSupport()) {
            return;
        }
        try {
            String usnm = System.getProperty("so.login.username");
            String pswd = System.getProperty("so.login.password");
            System.getProperties().remove("so.login.username");
            System.getProperties().remove("so.login.password");
            Global.LAZY_START = false;
            if (usnm != null && pswd != null) {
                Global.LAZY_START = true;
                this.jUserName.setText(usnm);
                this.jPasswd.setText(pswd);
                Runnable run = new Runnable(){

                    @Override
                    public void run() {
                        DefaultLoginDialogSkin.this.jButtonOk.doClick();
                    }
                };
                SwingUtilities.invokeLater(run);
            }
        }
        catch (SecurityException e) {
            Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.SEVERE, null, e);
        }
    }

    protected boolean isNoDecorationWithoutTitle() {
        return false;
    }

    protected boolean isMetalDecorationDefault() {
        return false;
    }

    protected boolean isEnableZoomIcon() {
        return true;
    }

    protected boolean isEnableUserUIDecoration() {
        return false;
    }

    protected Dimension getIconPanelPrefSize() {
        return LoginDialog.PREF_SIZE;
    }

    protected boolean isLazyStartSupport() {
        return true;
    }

    protected JFrame createFrame() {
        if (this.applicationName == null && this.isNoDecorationWithoutTitle()) {
            this.loginFrame = new JFrame("");
            this.loginFrame.setIconImage(icon.getImage());
            this.loginFrame.setUndecorated(true);
            if (this.isMetalDecorationDefault()) {
                this.loginFrame.getRootPane().setBorder(new UndecoratedFrameMetalBorder());
            } else {
                this.loginFrame.getRootPane().setBorder(this.getDefaultFrameBorder());
            }
        } else {
            boolean decor = JFrame.isDefaultLookAndFeelDecorated();
            if (!decor) {
                JFrame.setDefaultLookAndFeelDecorated(true);
            }
            this.loginFrame = new JFrame("");
            this.loginFrame.setIconImage(icon.getImage());
            if (UIManager.getLookAndFeel().getSupportsWindowDecorations()) {
                this.loginFrame.getRootPane().setWindowDecorationStyle(2);
            }
            if (!decor) {
                JFrame.setDefaultLookAndFeelDecorated(false);
            }
        }
        if (this.applicationName == null) {
            LoginDialogSkinParser.importSkin(this.loginFrame);
        } else {
            this.loginFrame.setTitle(this.applicationName);
        }
        this.lastLNF = UIManager.getLookAndFeel();
        return this.loginFrame;
    }

    public Border getDefaultFrameBorder() {
        UIDefaults table = UIManager.getLookAndFeelDefaults();
        return new BorderUIResource.CompoundBorderUIResource(new BevelBorder(0, table.getColor("InternalFrame.borderLight"), table.getColor("InternalFrame.borderHighlight"), table.getColor("InternalFrame.borderDarkShadow"), table.getColor("InternalFrame.borderShadow")), BorderFactory.createLineBorder(table.getColor("InternalFrame.borderColor"), 1));
    }

    protected JPanel createIconPanel() {
        JPanel rval = new JPanel();
        rval.setOpaque(false);
        return rval;
    }

    protected JPanel getIconPanel() {
        if (this.iconPanel == null) {
            this.iconPanel = this.createIconPanel();
        }
        return this.iconPanel;
    }

    protected JPanel createLineStartPanel() {
        JPanel p = new JPanel(new BorderLayout());
        p.setOpaque(false);
        p.add(Box.createHorizontalStrut(25), "After");
        p.add((Component)this.getIconPanel(), "Before");
        return p;
    }

    protected boolean correctContentPane(JFrame loginFrame) {
        if (!(loginFrame.getContentPane() instanceof KPanel)) {
            loginFrame.setContentPane((Container)new KPanel());
            return true;
        }
        return false;
    }

    protected void prepareContentPane(KPanel panel) {
        panel.setLayout((LayoutManager)new BorderLayout());
        panel.setBackgroundImage((Icon)IconResourcer.getIcon((String)"img/BG_Login.gif"), 0);
        panel.setSupportRL(false);
        panel.setOpaque(false);
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
    }

    protected JPanel createPageEndPanel() {
        JPanel south = new JPanel();
        south.setOpaque(false);
        south.setLayout(new BorderLayout());
        south.add(Box.createVerticalStrut(20), "First");
        this.buttons = this.createButtonsPanel();
        south.add((Component)this.buttons, "After");
        this.initLabelSecurity();
        JPanel south1 = new JPanel(new BorderLayout());
        south1.setOpaque(false);
        south1.add((Component)this.labelSecurity, "Before");
        south1.add((Component)this.createStatusPanel(), "Last");
        south.add((Component)south1, "Last");
        return south;
    }

    protected void initLabelSecurity() {
        Font labelSecurityFont = FontRewriteSkinParser.getKernelFont("login.security", new Font("Ariel", 0, 11));
        this.labelSecurity.setFont(labelSecurityFont);
        MouseListener listener = this.createLabelSecurityMouseListener();
        if (listener != null) {
            this.labelSecurity.addMouseListener(listener);
        }
    }

    protected MouseListener createLabelSecurityMouseListener() {
        return new MouseAdapter(){

            @Override
            public void mouseClicked(MouseEvent e) {
                SSLInfoDialog dialog = new SSLInfoDialog((Frame)iconFrame, true);
                dialog.show();
            }
        };
    }

    protected JPanel createStatusPanel() {
        JPanel statusPanel = new JPanel(new BorderLayout());
        statusPanel.setOpaque(false);
        this.capslockLabel = this.createCapslockLabel();
        this.statusLabel = this.createStatusLabel();
        statusPanel.add((Component)this.capslockLabel, "Before");
        statusPanel.add((Component)this.statusLabel, "After");
        return statusPanel;
    }

    protected JLabel createCapslockLabel() {
        JLabel capslockLabel = new JLabel(""){

            @Override
            public Dimension getPreferredSize() {
                Dimension dim = super.getPreferredSize();
                dim.height = 30;
                return dim;
            }
        };
        capslockLabel.setFont(new Font(capslockLabel.getFont().getFontName(), 0, 10));
        capslockLabel.setMaximumSize(new Dimension(2000, 30));
        capslockLabel.setHorizontalTextPosition(10);
        capslockLabel.setHorizontalAlignment(11);
        return capslockLabel;
    }

    protected JLabel createStatusLabel() {
        JLabel statusLabel = new JLabel(""){

            @Override
            public Dimension getPreferredSize() {
                Dimension dim = super.getPreferredSize();
                dim.height = 30;
                return dim;
            }
        };
        statusLabel.setFont(new Font(statusLabel.getFont().getFontName(), 0, 10));
        statusLabel.setMaximumSize(new Dimension(2000, 30));
        statusLabel.setHorizontalTextPosition(10);
        statusLabel.setHorizontalAlignment(11);
        return statusLabel;
    }

    /*
     * WARNING - Removed try catching itself - possible behaviour change.
     */
    protected void createFrameContent() {
        boolean neww = this.correctContentPane(this.loginFrame);
        KPanel panel = (KPanel)this.loginFrame.getContentPane();
        KPanelSkinParser.importSkin(panel, "xml/login.xml");
        if (this.buttons == null || neww) {
            this.prepareContentPane(panel);
            panel.add((Component)this.createLineStartPanel(), (Object)"Before");
            this.setIconPanelDefault();
            JPanel fields = this.createFieldPanel();
            panel.add((Component)fields, (Object)"Center");
            JPanel south = this.createPageEndPanel();
            panel.add((Component)south, (Object)"Last");
        }
        this.createText();
        Object object = this.LOCK;
        synchronized (object) {
            while (!this.isSetIcon) {
                try {
                    this.LOCK.wait();
                }
                catch (InterruptedException _) {}
            }
        }
        if (neww) {
            this.loginFrame.pack();
            SwingUtilities.invokeLater(new Runnable(){

                @Override
                public void run() {
                    DefaultLoginDialogSkin.this.loginFrame.pack();
                    DefaultLoginDialogSkin.this.mySize = DefaultLoginDialogSkin.this.loginFrame.getSize();
                }
            });
        }
    }

    protected KeyListener createKeyHandler() {
        return new KeyHandler();
    }

    protected void initListeners(JTextField userName, JPasswordField passwd) {
        KeyListener aKeyListener = this.createKeyHandler();
        if (aKeyListener != null) {
            passwd.addKeyListener(aKeyListener);
            userName.addKeyListener(aKeyListener);
        }
        KeyAdapter capsCheck = new KeyAdapter(){

            @Override
            public void keyPressed(KeyEvent e) {
                DefaultLoginDialogSkin.this.checkCapsLock(e);
            }
        };
        FocusAdapter fa = new FocusAdapter(){

            @Override
            public void focusGained(FocusEvent e) {
                DefaultLoginDialogSkin.this.checkCapsLock(null);
            }
        };
        userName.addKeyListener(capsCheck);
        userName.addFocusListener(fa);
        passwd.addKeyListener(capsCheck);
        passwd.addFocusListener(fa);
    }

    protected JLabel createUserNameLabel(Font skinLabelFont) {
        KLabel jLable2 = new KLabel();
        jLable2.setHorizontalAlignment(11);
        jLable2.setFont(skinLabelFont);
        return jLable2;
    }

    protected JTextField createUserNameTextField(Color fieldColor, Font skinFieldFont) {
        JTextField jUserName = this.getJUserName();
        jUserName = jUserName == null ? new KTextField(15) : new KTextField(jUserName.getText(), 15);
        jUserName.setEnabled(false);
        jUserName.setForeground(fieldColor);
        jUserName.setFont(skinFieldFont);
        jUserName.setBackground(Color.WHITE);
        jUserName.setBorder(BorderFactory.createLineBorder(new Color(106, 130, 165), 1));
        jUserName.setOpaque(true);
        return jUserName;
    }

    protected JLabel createPasswdLabel(Font skinLabelFont) {
        this.jlPasswd = new KLabel((Icon)IconResourcer.getIcon((String)"img/key.gif"), 11);
        return this.jlPasswd;
    }

    protected JPasswordField createPasswdField(Color fieldColor, Font skinFieldFont) {
        KPasswordField rval = new KPasswordField();
        rval.setEchoChar('*');
        rval.setEnabled(false);
        rval.setForeground(fieldColor);
        rval.setFont(skinFieldFont);
        rval.setBackground(Color.WHITE);
        rval.setBorder(BorderFactory.createLineBorder(new Color(106, 130, 165), 1));
        rval.setOpaque(true);
        return rval;
    }

    protected JPanel createFieldPanel() {
        JPanel panel = new JPanel();
        panel.setLayout(new BoxLayout(panel, 1));
        panel.setOpaque(false);
        panel.add(Box.createVerticalGlue());
        Color loginFieldColor = new Color(75, 98, 132);
        Font loginFieldFont = FontRewriteSkinParser.getKernelFont("login.field", new Font("Ariel", 0, 11));
        Font labelFont = FontRewriteSkinParser.getKernelFont("login.label", new Font("Ariel", 0, 11));
        JPanel fields = new JPanel();
        fields.setBorder(BorderFactory.createCompoundBorder(BorderFactory.createLoweredBevelBorder(), BorderFactory.createEmptyBorder(5, 5, 5, 5)));
        fields.setOpaque(false);
        GridBagLayout layout = new GridBagLayout();
        GridBagConstraints gbc = new GridBagConstraints();
        fields.setLayout(layout);
        this.jlUserName = this.createUserNameLabel(labelFont);
        gbc.fill = 2;
        gbc.anchor = 10;
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.weightx = 0.1;
        fields.add((Component)this.jlUserName, gbc);
        this.jUserName = this.createUserNameTextField(loginFieldColor, loginFieldFont);
        gbc.weightx = 1.0;
        gbc.gridwidth = 0;
        fields.add((Component)this.jUserName, gbc);
        this.jlPasswd = this.createPasswdLabel(labelFont);
        gbc.weightx = 0.1;
        gbc.gridwidth = 1;
        fields.add((Component)this.jlPasswd, gbc);
        this.jPasswd = this.createPasswdField(loginFieldColor, loginFieldFont);
        gbc.weightx = 1.0;
        gbc.gridwidth = 0;
        fields.add((Component)this.jPasswd, gbc);
        this.fingerprintLabel = new KLabel();
        this.fingerprintLabel.setFont(labelFont);
        gbc.weightx = 1.0;
        gbc.gridwidth = 0;
        this.fingerprintLabel.setVisible(false);
        fields.add((Component)this.fingerprintLabel, gbc);
        panel.add(fields);
        panel.add(Box.createVerticalGlue());
        this.initListeners(this.jUserName, this.jPasswd);
        return panel;
    }

    protected void createText() {
        this.jlUserName.setText(DefaultLoginDialogSkin.lng("Login name"));
        this.fingerprintLabel.setText(DefaultLoginDialogSkin.lng("... or use the fingerprint scanner."));
        this.jPasswd.setToolTipText(DefaultLoginDialogSkin.lng("Enter your password."));
        this.jUserName.setToolTipText(DefaultLoginDialogSkin.lng("Enter your login name."));
        this.jButtonOk.setToolTipText(DefaultLoginDialogSkin.lng("Login"));
        this.jButtonCancel.setToolTipText(DefaultLoginDialogSkin.lng("Cancel login"));
    }

    protected JProgressBar createProgressBar() {
        return new JProgressBar(){

            @Override
            public void setOpaque(boolean bool) {
                super.setOpaque(false);
            }
        };
    }

    protected void initProgressBar(JProgressBar progressBar) {
        progressBar.setForeground(new Color(128, 128, 192));
        progressBar.setBorderPainted(true);
        progressBar.setPreferredSize(new Dimension(155, 11));
    }

    protected JButton createOkButton() {
        KButton rval = new KButton("Yes");
        ActionListener listener = this.createOkButtonActionHandler();
        if (listener != null) {
            rval.addActionListener(listener);
        }
        return rval;
    }

    protected ActionListener createOkButtonActionHandler() {
        return new ActionListener(){

            @Override
            public void actionPerformed(ActionEvent e) {
                DefaultLoginDialogSkin.this.jButtonOk.setEnabled(false);
                DefaultLoginDialogSkin.this.jButtonCancel.setFocusable(false);
                DefaultLoginDialogSkin.this.jPasswd.setEnabled(false);
                DefaultLoginDialogSkin.this.jUserName.setEnabled(false);
                DefaultLoginDialogSkin.this.jButtonCancel.transferFocus();
                Thread loginThread = new Thread(){

                    @Override
                    public void run() {
                        if (Boolean.FALSE.equals(DefaultLoginDialogSkin.this.loginDialog.login())) {
                            SwingUtilities.invokeLater(new Runnable(){

                                @Override
                                public void run() {
                                    DefaultLoginDialogSkin.this.jButtonOk.setEnabled(true);
                                    DefaultLoginDialogSkin.this.jButtonCancel.setFocusable(true);
                                    DefaultLoginDialogSkin.this.jPasswd.setEnabled(true);
                                    DefaultLoginDialogSkin.this.jUserName.setEnabled(true);
                                    DefaultLoginDialogSkin.this.jPasswd.requestFocus();
                                    DefaultLoginDialogSkin.this.fingerprintRecord = null;
                                }
                            });
                            if (DefaultLoginDialogSkin.this.fingerprintDirector != null && !DefaultLoginDialogSkin.this.fingerprintDirector.isScanning()) {
                                DefaultLoginDialogSkin.this.fingerprintDirector.scanOnce();
                            }
                        }
                    }
                };
                loginThread.setPriority(9);
                loginThread.start();
            }
        };
    }

    protected JButton createCancelButton() {
        KButton rval = new KButton("Cancel");
        ActionListener listener = this.createCancelButtonActionHandler();
        if (listener != null) {
            rval.addActionListener(listener);
        }
        return rval;
    }

    protected ActionListener createCancelButtonActionHandler() {
        return new ActionListener(){

            @Override
            public void actionPerformed(ActionEvent e) {
                if (DefaultLoginDialogSkin.this.fingerprintDirector != null) {
                    DefaultLoginDialogSkin.this.fingerprintDirector.stopScanning();
                }
                DefaultLoginDialogSkin.this.loginDialog.cancelLogin();
            }
        };
    }

    protected JPanel createButtonsPanel() {
        JPanel buttonsPanel = new JPanel();
        buttonsPanel.setOpaque(false);
        buttonsPanel.setLayout(new FlowLayout(0));
        if (this.progressBar == null) {
            this.progressBar = this.createProgressBar();
        }
        this.initProgressBar(this.progressBar);
        buttonsPanel.add(this.progressBar);
        this.jButtonOk = this.createOkButton();
        buttonsPanel.add(this.jButtonOk);
        this.jButtonCancel = this.createCancelButton();
        buttonsPanel.add(this.jButtonCancel);
        return buttonsPanel;
    }

    protected void createJFrameListeners() {
        this.loginFrame.addWindowListener(new WindowAdapter(){

            @Override
            public void windowClosing(WindowEvent event) {
                DefaultLoginDialogSkin.this.loginDialog.cancelLogin();
            }
        });
        this.loginFrame.setResizable(false);
    }

    protected String sslctx() {
        String rval = null;
        SSLContext ctx = SSLUtilities.createSSLContext((String)null);
        SSLSessionContext sslCtx = ctx.getClientSessionContext();
        Enumeration<byte[]> _enum = sslCtx.getIds();
        while (_enum.hasMoreElements()) {
            byte[] id = _enum.nextElement();
            SSLSession session = sslCtx.getSession(id);
            rval = session.getCipherSuite();
        }
        return rval;
    }

    @Override
    public void setLoginDialog(LoginDialog loginDialog) {
        this.loginDialog = loginDialog;
    }

    @Override
    public void setApplicationName(String appName) {
        if (this.applicationName == null && appName != null && this.isNoDecorationWithoutTitle() && this.loginFrame.isUndecorated()) {
            this.applicationName = appName;
            this.changeDecorationPVT(-20);
            return;
        }
        this.applicationName = appName;
        if (this.loginFrame != null) {
            this.loginFrame.setTitle(appName);
        }
    }

    @Override
    public JFrame getLoginFrame() {
        return this.loginFrame;
    }

    @Override
    public void setIconPanel(final ImageIcon loginIcon) {
        Runnable doIt = new Runnable(){

            /*
             * WARNING - Removed try catching itself - possible behaviour change.
             */
            @Override
            public void run() {
                ImageIcon icon = loginIcon;
                Dimension prefSize = DefaultLoginDialogSkin.this.getIconPanelPrefSize();
                if (prefSize != null && DefaultLoginDialogSkin.this.isEnableZoomIcon()) {
                    int max = Math.min(prefSize.width, prefSize.height);
                    icon = IconResourcer.getScaledIconMax((ImageIcon)loginIcon, (int)max);
                }
                if (DefaultLoginDialogSkin.this.iconPanel.getComponentCount() > 0) {
                    DefaultLoginDialogSkin.this.lIconPanel.setIcon(icon);
                    DefaultLoginDialogSkin.this.lIconPanel.setBorder(BorderFactory.createLoweredBevelBorder());
                } else {
                    DefaultLoginDialogSkin.this.iconPanel.setLayout(new BorderLayout());
                    DefaultLoginDialogSkin.this.lIconPanel = (JLabel)new KLabel((Icon)icon, 0);
                    if (prefSize != null) {
                        DefaultLoginDialogSkin.this.lIconPanel.setPreferredSize(prefSize);
                    }
                    DefaultLoginDialogSkin.this.iconPanel.add((Component)DefaultLoginDialogSkin.this.lIconPanel, "Center");
                }
                Object object = DefaultLoginDialogSkin.this.LOCK;
                synchronized (object) {
                    DefaultLoginDialogSkin.this.isSetIcon = true;
                    DefaultLoginDialogSkin.this.LOCK.notifyAll();
                }
            }
        };
        if (SwingUtilities.isEventDispatchThread()) {
            doIt.run();
        } else if (this.isSetIcon) {
            SwingUtilities.invokeLater(doIt);
        } else {
            try {
                DispatchThreadInvoker.invokeAndWait((Runnable)doIt);
            }
            catch (InterruptedException _) {
                Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.SEVERE, null, _);
            }
            catch (InvocationTargetException _) {
                Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.SEVERE, null, _.getTargetException());
            }
        }
    }

    @Override
    public void setIconPanelDefault() {
        this.loginIcon = IconResourcer.getIcon((String)"img/login.gif");
        this.setIconPanel(this.loginIcon);
    }

    @Override
    public void changeDecoration() {
        if (this.isEnableUserUIDecoration() || this.isMetalDecorationDefault()) {
            this.changeDecorationPVT(0);
        }
    }

    @Override
    public void show() {
        if (this.loginFrame == null) {
            this.createLoginFrame();
        }
        GraphicsConfiguration gc = this.loginFrame.getGraphicsConfiguration();
        Rectangle bounds = gc.getBounds();
        Dimension size = this.loginFrame.getSize();
        int x = bounds.x + (bounds.width - size.width) / 2;
        int y = bounds.y + (bounds.height - size.height) / 2;
        this.loginFrame.setLocation(x, y);
        this.loginFrame.setVisible(true);
    }

    @Override
    public void dispose() {
        if (this.loginFrame != null) {
            this.loginFrame.setVisible(false);
            this.loginFrame.dispose();
            this.setOtherLabel("");
            this.loginFrame = null;
            this.isSetIcon = false;
        }
    }

    @Override
    public JProgressBar showProgress() {
        if ("".equals(this.jUserName.getText()) && this.userId != null) {
            this.jUserName.setText(this.userId.getLoginName());
        }
        this.jButtonOk.setEnabled(false);
        this.jButtonOk.transferFocus();
        this.jButtonCancel.setFocusable(false);
        this.progressBar.setVisible(true);
        this.jUserName.setEnabled(false);
        this.jPasswd.setEnabled(false);
        return this.progressBar;
    }

    @Override
    public void hideProgress() {
        Runnable run = new Runnable(){

            @Override
            public void run() {
                String s = DefaultLoginDialogSkin.this.sslctx();
                if (s == null) {
                    s = "SSL/DSA 1024-bits";
                }
                s = DefaultLoginDialogSkin.lng(s);
                DefaultLoginDialogSkin.this.setSecurityLabel(s);
                DefaultLoginDialogSkin.this.jButtonOk.setEnabled(true);
                DefaultLoginDialogSkin.this.jButtonCancel.setFocusable(true);
                DefaultLoginDialogSkin.this.jUserName.setEnabled(true);
                DefaultLoginDialogSkin.this.jPasswd.setEnabled(true);
                Color textBackground = new KTextField().getBackground();
                DefaultLoginDialogSkin.this.jUserName.setBackground(textBackground);
                DefaultLoginDialogSkin.this.jPasswd.setBackground(textBackground);
                DefaultLoginDialogSkin.this.jUserName.repaint();
                DefaultLoginDialogSkin.this.checkAutoUser();
                DefaultLoginDialogSkin.this.initFingerprintLogin();
                if (DefaultLoginDialogSkin.this.jUserName.getText().length() == 0) {
                    DefaultLoginDialogSkin.this.jUserName.requestFocus();
                } else {
                    DefaultLoginDialogSkin.this.jPasswd.requestFocus();
                }
            }
        };
        if (SwingUtilities.isEventDispatchThread()) {
            run.run();
        } else {
            try {
                SwingUtilities.invokeAndWait(run);
            }
            catch (InterruptedException e) {
                Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.SEVERE, null, e);
            }
            catch (InvocationTargetException e) {
                Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.SEVERE, null, e.getTargetException());
            }
        }
    }

    protected void initFingerprintLogin() {
        this.fingerprintDirector = this.loginDialog.getFingerprintDirector();
        if (this.fingerprintDirector != null) {
            FingerprintListener fingerprintListener = new FingerprintListener(){

                public void fingerScanned(FingerprintImage image) {
                }

                public void fingerGeneralized(FingerprintRecord record) {
                    if (record != null) {
                        DefaultLoginDialogSkin.this.fingerprintRecord = record;
                        DefaultLoginDialogSkin.this.jButtonOk.doClick();
                    } else {
                        DefaultLoginDialogSkin.this.showConfirmDialog(DefaultLoginDialogSkin.lng("Finger image with low quality. Try again."), DefaultLoginDialogSkin.lng("Error during scan"), 0, 2);
                        if (!DefaultLoginDialogSkin.this.fingerprintDirector.isScanning()) {
                            DefaultLoginDialogSkin.this.fingerprintDirector.scanOnce();
                        }
                    }
                }
            };
            this.loginDialog.addFingerprintListener(fingerprintListener);
            this.fingerprintDirector.scanOnce();
            this.fingerprintLabel.setVisible(true);
        }
    }

    @Override
    public void setStatusLabel(String status) {
        if (!SwingUtilities.isEventDispatchThread()) {
            throw new IllegalStateException("Not a EventDispatchThread");
        }
        if ("".equals(status)) {
            this.statusLabel.setText("");
            this.statusLabel.setIcon(null);
        } else {
            this.statusLabel.setText(status);
            this.statusLabel.setIcon(IconResourcer.getIcon((String)"img/Icon_Busy.gif"));
        }
    }

    protected Object getAttributeValue(Attributes attrs, String attrId) {
        Attribute attr = attrs.get(attrId);
        try {
            return attr == null ? null : attr.get();
        }
        catch (NamingException ex) {
            Logger.getLogger(DefaultLoginDialogSkin.class.getName()).log(Level.INFO, "Cannot get value of " + attrId, ex);
            return null;
        }
    }

    protected String getAttributeStringValue(Attributes attrs, String attrId) {
        Object val = this.getAttributeValue(attrs, attrId);
        if (val instanceof String) {
            return (String)val;
        }
        return null;
    }

    @Override
    public void fillLoginInformation(UserId userId) {
        Attributes attrs = userId.getAttributes();
        if (attrs != null) {
            userId.setLoginName(null);
            String userName = this.getAttributeStringValue(attrs, "name");
            if (StringUtil.isEmptyString((String)userName)) {
                return;
            }
            String method = this.getAttributeStringValue(attrs, "method");
            if (StringUtil.isEmptyString((String)method)) {
                return;
            }
            this.jUserName.setText(userName);
            userId.setLoginName(userName);
            return;
        }
        userId.setLoginName(this.jUserName.getText());
        char[] passwd = this.jPasswd.getPassword();
        if (passwd != null) {
            userId.setPasswd(new String(passwd));
        }
        UserBiometrics userBio = new UserBiometrics();
        userBio.setFigerprintRecord(this.fingerprintRecord);
        userId.setUserBiometrics(userBio);
        this.userId = userId;
    }

    @Override
    public int showConfirmDialog(String message, String title, int optionType, int messageType) {
        return KOptionPane.showConfirmDialog((Component)this.loginFrame, (Object)message, (String)title, (int)optionType, (int)messageType);
    }

    @Override
    public int showConfirmDialog(String message, String title, int optionType, int messageType, Icon icon) {
        return KOptionPane.showConfirmDialog((Component)this.loginFrame, (Object)message, (String)title, (int)optionType, (int)messageType, (Icon)icon);
    }

    @Override
    public boolean supportSELogin() {
        return false;
    }

    @Override
    public int getSEStepCount() {
        return 0;
    }

    @Override
    public void resetSELogin() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void nextSEPage(String additionalInfo) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void fillSEInfo(Map<String, Object> seInfo) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public String getSECode() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    protected static String lng(String property) {
        return LoginDialog.lng(property);
    }

    static {
        if (icon != null) {
            icon.getImageLoadStatus();
            iconFrame.setIconImage(icon.getImage());
        }
    }

    protected static class UndecoratedFrameMetalBorder
    extends AbstractBorder {
        private static final long serialVersionUID = 179630061548626312L;
        private static final Insets INSETS = new Insets(5, 5, 5, 5);
        private static final int CORNER = 14;

        protected UndecoratedFrameMetalBorder() {
        }

        protected Color getActiveBackground() {
            return MetalLookAndFeel.getPrimaryControlDarkShadow();
        }

        protected Color getActiveHighlight() {
            return MetalLookAndFeel.getPrimaryControlShadow();
        }

        protected Color getActiveShadow() {
            return MetalLookAndFeel.getPrimaryControlInfo();
        }

        protected Color getInactiveBackground() {
            return MetalLookAndFeel.getControlDarkShadow();
        }

        protected Color getInactiveHighlight() {
            return MetalLookAndFeel.getControlShadow();
        }

        protected Color getInactiveShadow() {
            return MetalLookAndFeel.getControlInfo();
        }

        @Override
        public void paintBorder(Component c, Graphics g, int x, int y, int w, int h) {
            Color shadow;
            Color highlight;
            Color background;
            Window window = SwingUtilities.getWindowAncestor(c);
            if (window != null && window.isActive()) {
                background = this.getActiveBackground();
                highlight = this.getActiveHighlight();
                shadow = this.getActiveShadow();
            } else {
                background = this.getInactiveBackground();
                highlight = this.getInactiveHighlight();
                shadow = this.getInactiveShadow();
            }
            g.setColor(background);
            g.drawLine(x + 1, y + 0, x + w - 2, y + 0);
            g.drawLine(x + 0, y + 1, x + 0, y + h - 2);
            g.drawLine(x + w - 1, y + 1, x + w - 1, y + h - 2);
            g.drawLine(x + 1, y + h - 1, x + w - 2, y + h - 1);
            for (int i = 1; i < 5; ++i) {
                g.drawRect(x + i, y + i, w - i * 2 - 1, h - i * 2 - 1);
            }
            if (window instanceof Frame && ((Frame)window).isResizable()) {
                g.setColor(highlight);
                g.drawLine(15, 3, w - 14, 3);
                g.drawLine(3, 15, 3, h - 14);
                g.drawLine(w - 2, 15, w - 2, h - 14);
                g.drawLine(15, h - 2, w - 14, h - 2);
                g.setColor(shadow);
                g.drawLine(14, 2, w - 14 - 1, 2);
                g.drawLine(2, 14, 2, h - 14 - 1);
                g.drawLine(w - 3, 14, w - 3, h - 14 - 1);
                g.drawLine(14, h - 3, w - 14 - 1, h - 3);
            }
        }

        @Override
        public Insets getBorderInsets(Component c) {
            return INSETS;
        }

        @Override
        public Insets getBorderInsets(Component c, Insets newInsets) {
            newInsets.top = UndecoratedFrameMetalBorder.INSETS.top;
            newInsets.left = UndecoratedFrameMetalBorder.INSETS.left;
            newInsets.bottom = UndecoratedFrameMetalBorder.INSETS.bottom;
            newInsets.right = UndecoratedFrameMetalBorder.INSETS.right;
            return newInsets;
        }
    }

    protected class KeyHandler
    extends KeyAdapter {
        protected KeyHandler() {
        }

        @Override
        public void keyPressed(KeyEvent event) {
            Object object = event.getSource();
            if (object == DefaultLoginDialogSkin.this.jPasswd && event.getKeyChar() == '\n') {
                DefaultLoginDialogSkin.this.jButtonOk.doClick();
                event.consume();
            } else if (object == DefaultLoginDialogSkin.this.jUserName && event.getKeyChar() == '\n') {
                DefaultLoginDialogSkin.this.jUserName.transferFocus();
                event.consume();
            }
        }
    }
}

